# Haworth Explicit Hydrogen Rendering Plan

## Title and objective

Objective: improve Haworth explicit-hydrogen rendering (`show_hydrogens=True`) with a cleaner visual treatment for standalone `H` labels while preserving the shared attach-target architecture and avoiding renderer-specific bond-label hacks.

## Scope and non-goals

Scope:
- Haworth rendering path only (`packages/oasa/oasa/haworth/*`, `packages/oasa/oasa/haworth_renderer.py` shim).
- Standalone explicit hydrogen labels only (single `H` labels attached directly to ring carbons).
- Visual treatment for standalone `H` labels (smaller font size and softer gray color).
- Attachment behavior using shared `AttachTarget`/`resolve_attach_endpoint(...)` contracts.
- Test expansion for explicit-hydrogen-on scenarios in unit and smoke gates.

Non-goals:
- No new molecule semantics or graph-level hydrogen expansion changes.
- No special-case endpoint branches keyed by label text in renderer policy logic.
- No changes to hydroxyl (`OH`/`HO`) or carbon-chain (`CH2OH`, `CH(OH)CH2OH`) attachment rules beyond shared-engine compliance.
- No multi-ring Haworth layout redesign in this plan.

## Current state summary

- Most Haworth regression coverage and archive parity checks run with `show_hydrogens=False`.
- Existing explicit-hydrogen rendering is functional but visually dense inside ring interiors.
- Shared attachment infrastructure exists and should remain the only endpoint legality path.
- Recent work already removed label-text endpoint policy branches in Haworth paths; this plan must not reintroduce them.

## Architecture boundaries and ownership

Primary code boundaries:
- `packages/oasa/oasa/haworth/renderer.py`: Haworth label/connectors assembly.
- `packages/oasa/oasa/haworth/renderer_text.py`: label formatting and text geometry helpers.
- `packages/oasa/oasa/haworth/renderer_layout.py`: label layout/penalty resolution.
- `packages/oasa/oasa/render_geometry.py`: shared attachment targets, endpoint resolution, retreat legality.
- `tests/test_haworth_renderer.py`, `tests/smoke/test_haworth_renderer_smoke.py`: explicit-H test coverage.

Ownership boundaries:
- Coder A: text/style contract + renderer plumbing.
- Coder B: attach-target conformance + regression tests.
- Reviewer: gate audit + documentation close-out verification.

## Phase plan (ordered, dependency-aware)

### Phase 0: Visual and semantics contract lock

Deliverables:
- Define standalone explicit-hydrogen classification rule:
  - standalone explicit hydrogen = label text exactly `H` generated by `show_hydrogens=True` for ring substituent slots.
  - excludes `OH`/`HO`, `CH2OH`, `CH3`, and branched chain labels.
- Define visual style constants for standalone explicit hydrogen:
  - `font_scale_h` (target default: `0.78` to `0.85` range, final value fixed by review).
  - `color_h` (target default: neutral gray, e.g. `#666666` to `#777777`, final value fixed by review).
- Define style application contract:
  - style applies to standalone `H` label text only.
  - connector geometry stays on shared attach-target path with no text-branch policy.

Done checks:
- Contract documented in this plan and mirrored in code comments in the implementation PR.
- No ambiguity on which labels receive style changes.

### Phase 1: Shared-path renderer integration

Deliverables:
- Introduce renderer-level parameterization for standalone-H style without forking attachment logic.
- Ensure standalone `H` text style uses:
  - reduced `font_size` at text-op level.
  - dedicated gray label color.
- Keep connector endpoints resolved through shared target APIs (no renderer-only bypasses).

Done checks:
- No new `if text == ...` endpoint-policy branches for attachment legality.
- Standalone `H` labels render with configured style in both pyranose and furanose examples.

### Phase 2: Layout stability and anti-overlap hardening

Deliverables:
- Update layout jobs to account for scaled standalone-H label dimensions in overlap calculations.
- Verify no degradation of current OH/HO and chain-label spacing behavior when `show_hydrogens=True`.

Done checks:
- Existing non-H explicit layout behavior remains stable under regression tests.
- Standalone `H` labels do not introduce new ring-edge or bond-label overlap failures.

### Phase 3: Verification and regression expansion

Deliverables:
- Add focused unit tests for explicit-H style and attach-target behavior.
- Add smoke cases that run representative archive mappings with `show_hydrogens=True`.
- Add regression checks that standalone `H` is styled while non-H labels are unchanged.

Done checks:
- New tests fail on legacy behavior and pass on updated behavior.
- Smoke checks verify no endpoint regressions under explicit-H mode.

### Phase 4: Rollout and close-out

Deliverables:
- Changelog and plan status updates.
- Refactor-progress note identifying explicit-H upgrade as in-progress/completed.
- One reviewer close-out pass with gate outcomes.

Done checks:
- All gates pass and documentation reflects final behavior.
- No unresolved blocker findings.

## Per-phase deliverables and done checks

- Phase 0 deliverables: classification + style constants + scope contract.
  - Done when classification and constants are documented and agreed.
- Phase 1 deliverables: renderer text styling integration on shared endpoint path.
  - Done when standalone `H` style is visible and no endpoint-policy text hacks are added.
- Phase 2 deliverables: layout stability under explicit-H mode.
  - Done when overlap/layout regressions are absent in targeted tests.
- Phase 3 deliverables: unit + smoke gate expansion.
  - Done when new tests pass and protect against rollback.
- Phase 4 deliverables: docs and governance close-out.
  - Done when changelog/progress/plan status are consistent.

## Acceptance criteria and gates

Unit gate:
- `source source_me.sh && /opt/homebrew/opt/python@3.12/bin/python3.12 -m pytest tests/test_haworth_renderer.py -q`
- Must pass with added explicit-H assertions.

Integration gate:
- `source source_me.sh && /opt/homebrew/opt/python@3.12/bin/python3.12 tools/archive_matrix_summary.py -r`
- Must complete without missing generated/reference entries.

Smoke gate:
- `source source_me.sh && /opt/homebrew/opt/python@3.12/bin/python3.12 -m pytest tests/smoke/test_haworth_renderer_smoke.py -q`
- Must pass for both existing default (`show_hydrogens=False`) and new explicit-H coverage.

Regression gate:
- `source source_me.sh && /opt/homebrew/opt/python@3.12/bin/python3.12 -m pytest -q`
- Must pass consecutively twice before closure.

Release gate:
- Reviewer confirms no endpoint-policy text hacks were introduced and style rules are limited to standalone `H` labels.

## Test and verification strategy

Test additions:
- Unit tests:
  - standalone `H` labels use reduced `font_size` and gray color.
  - `OH`/`HO`, `CH2OH`, `CH3`, and chain labels do not inherit standalone-H style.
  - connector endpoint legality remains on shared attach-target path.
- Smoke tests:
  - representative pyranose/furanose fixtures with `show_hydrogens=True`.
  - overlap gate remains strict with explicit hydrogens enabled.

Failure semantics:
- Any overlap regression or endpoint legality drift blocks progression to release.
- Any label-class leakage (e.g., styling `OH` as standalone-H) blocks progression.

## Migration and compatibility policy

Additive rollout:
- Introduce standalone-H style behavior behind renderer-level parameters/constants first.
- Keep existing API signatures backward-compatible where possible.

Compatibility promises:
- `show_hydrogens=False` output should remain visually stable.
- Non-H labels retain existing styling unless explicitly documented otherwise.
- Attachment resolution remains shared-path and deterministic.

Deletion/cleanup policy:
- Remove temporary transitional flags/constants once defaults are finalized and tests lock behavior.
- Do not retain alternate endpoint-policy paths for standalone-H labels.

Rollback policy:
- If explicit-H style destabilizes overlap gates, revert to baseline styling while keeping new tests and reintroduce style in a narrowed patch.

## Risk register and mitigations

- Risk: style-only change accidentally alters connector endpoint logic.
  - Impact: High.
  - Mitigation: enforce no new text-branch endpoint policy; add regression tests for target resolution path.
  - Owner: Coder B.

- Risk: smaller H font causes unexpected layout crowding in select furanose interiors.
  - Impact: Medium.
  - Mitigation: run explicit-H smoke matrix and adjust scale within predefined range.
  - Owner: Coder A.

- Risk: style leakage to non-H labels (OH/CH2OH/CH3).
  - Impact: Medium.
  - Mitigation: explicit classification tests by label class.
  - Owner: Coder A.

- Risk: archive preview expectations drift if explicit-H runs are mixed with default smoke views.
  - Impact: Low.
  - Mitigation: keep archive parity defaults on `show_hydrogens=False`; explicit-H runs are additional gates.
  - Owner: Reviewer.

## Rollout and release checklist

- [ ] Phase 0 contract approved.
- [ ] Phase 1 implementation merged.
- [ ] Phase 2 layout verification complete.
- [ ] Unit, integration, smoke, and regression gates pass.
- [ ] Second consecutive full-suite pass recorded.
- [ ] Changelog and progress tracker updated.
- [ ] Reviewer close-out decision recorded (`Complete` or `Complete with follow-ups`).

## Documentation close-out requirements

- Update `docs/CHANGELOG.md` with:
  - explicit-H standalone style behavior.
  - gate commands and outcomes.
- Update `refactor_progress.md` status entry for this plan.
- Keep `docs/active_plans/HAWORTH_IMPLEMENTATION_PLAN_attempt2.md` linked as prior context and ensure no status conflict.

## Open questions and decisions needed

1. Final standalone `H` font scale value (`0.78` vs `0.82` vs `0.85`)?
2. Final standalone `H` gray color token (e.g., `#666666` vs `#707070`)?
3. Should standalone-H style be default-on when `show_hydrogens=True`, or gated by an explicit optional renderer argument for one release cycle?
4. Do we want one dedicated explicit-H snapshot artifact in `output_smoke/` for visual review, separate from archive parity views?
